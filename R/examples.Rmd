---
title: "Interactive examples"
author: "Paolo Eusebi"
date: "28/10/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

## Load packages and functions

```{r}
library(tidyverse)
library(runjags)
library(rjags)
library(rootSolve)
library(kableExtra)
testjags()

source("functions.R") # functions for data simulations
source("models.R")    # Bayesian models
```

# One imperfect reference test

We simulate data for 10,000 patients. `r p1<-0.5; print(p1, 2)` is the proportion of subjects with the disease in subjects with no vaccination. The sensitivity and specificity for the imperfect test used for ascertaining cases and controls are 0.90 and 0.75 respectively. The true OR is `r OR<-0.2; OR` (so the proportion in unvaccinated is `r p2<-(p1*OR)/(1+OR*p1-p1); p2`).
We don't consider at this stage that the probability of being vaccinated could dependend on patient characteristics.

```{r}
set.seed(1234)
d <- sim_ve_1_imperfect_test(covariates = F,
                             n = 10000, 
                             base_dis_prev = 0.5,
                             Se = 0.90,
                             Sp = 0.75,
                             true_OR = 0.2)
# Simulated data
d$data

# raw estimate of OR
round(d$`estimated OR`, 2) 
```



The Bayesian Model is fitted using prior information about test accuracy parameters.
Let's suppose our prior information, based on available evidence, is that 95% of the sensitivity distribution lies in the [0.875 to 0.925] interval and 95% of the specificity lies in the [0.70 to 0.80] interval.
These intervals are compatible with the probability distribution of our simulated values.


```{r}
y <- d$data
m <- 2
N <- apply(y, 1, sum)

HPSp <- findbetaqq2(percentile.value1 = 0.875, percentile1 = 0.025,
                    percentile.value2 = 0.925, percentile2 = 0.975)

HPSe <- findbetaqq2(percentile.value1 = 0.7, percentile1 = 0.025,
                    percentile.value2 = 0.8, percentile2 = 0.975)

ggplot(data = data.frame(x=seq(0, 1, 0.001))) +
  stat_function(fun = function(x) dbeta(x, HPSe[1], HPSe[2]), color = "red", size = 1) +
  stat_function(fun = function(x) dbeta(x, HPSp[1], HPSp[2]), color = "green", size = 1) +
labs(title = "Priors for Sensitivity (Red) and Specificity (Green)")  

## initial values
inits1 = list(".RNG.name" ="base::Mersenne-Twister", ".RNG.seed" = 100022)
inits2 = list(".RNG.name" ="base::Mersenne-Twister", ".RNG.seed" = 300022)
inits3 = list(".RNG.name" ="base::Mersenne-Twister", ".RNG.seed" = 500022)

## run
results <- run.jags(
  bm_1test_nondif,
  n.chains = 3,
  inits = list(inits1, inits2, inits3),
  burnin = 10000,
  thin = 10, # needed for convergence
  sample = 30000
)

res <- summary(results)[,c(1:3, 9:11)]
res[] <- round(res, 3)
kable(res) %>%
  kable_styling()

plot(
  results,
  vars = list("OR"),
  plot.type = c("trace", "histogram", "autocorr", "ecdf")
)
```

A thinning of 10 was needed to improve the autocorrelation, while the increase of burnin avoided some crazy posterior values for the OR.

# Two imperfect reference tests
We simulate data for 10,000 patients. Again, `r p1<-0.5; print(p1, 2)` is the proportion of subjects with the disease in subjects with no vaccination. The sensitivity and specificity for the imperfect test originally used for ascertaining cases and controls are 0.90 and 0.75 respectively (as in the example above). 
We have another test available, with sensitivity and specificity either equals to 0.80.
Again, the true OR is `r OR<-0.2; OR` (so the proportion in unvaccinated is `r p2<-(p1*OR)/(1+OR*p1-p1); p2`).

```{r}
set.seed(1234)
d <- sim_ve_2_imperfect_tests(covariates = F,
                              n = 100000,
                              base_dis_prev = 0.5,
                              Se1 = 0.95,
                              Sp1 = 0.90,
                              Se2 = 0.80,
                              Sp2 = 0.80,
                              true_OR = 0.2)

# Simulated data
d$data

# raw estimate of OR using Test 1
round(d$`estimated OR T1`, 2) 

# raw estimate of OR using Test 2
round(d$`estimated OR T2`, 2) 
```

A Bayesian Latent Class Model is fitted using a 2 populations-2 tests framework.
We used uninformative prior information for the accuracy parameters of the two tests.

```{r}

y <- d$data
m <- 2
N <- apply(y, 1, sum)

HPSe = matrix(c(1,1,1,1), nrow = 2)
HPSp = matrix(c(1,1,1,1), nrow = 2)

## run
results <- run.jags(
  blcm_2test_nondif,
  n.chains = 3,
  inits = list(inits1, inits2, inits3),
  burnin = 1000,
  sample = 10000
)

res <- summary(results)[,c(1:3, 9:11)]
res[] <- round(res, 3)
kable(res) %>%
  kable_styling()

plot(
  results,
  vars = list("OR"),
  plot.type = c("trace", "histogram", "autocorr", "ecdf")
)


```



